// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// 1. Staff & Authentication
enum Role {
  SUPER_ADMIN
  ADMIN
  SALES
  STAFF
}

model User {
  id          String  @id @default(uuid())
  password    String?
  firstName   String
  lastName    String
  email       String  @unique
  phoneNumber String? @unique

  role              Role      @default(STAFF)
  commissionPerHead Decimal?  @db.Decimal(10, 2) // Amount, e.g., 1000.00
  isActive          Boolean   @default(true)
  resetToken        String?   @unique
  resetTokenExpiry  DateTime?

  leads         Lead[]
  tasks         Task[]
  interactions  Interaction[]
  notifications Notification[]
  bookings      Booking[]      @relation("AgentBookings")
  commissions   Commission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 2. Customer Management
enum Title {
  MR
  MRS
  MISS
  MASTER
  OTHER
}

enum FoodAllergyType {
  DIARY
  EGGS
  FISH
  CRUSTACEAN
  GLUTEN
  PEANUT_AND_NUTS
  OTHER
}

model Customer {
  id String @id @default(uuid())

  title Title?

  firstNameEn String
  lastNameEn  String
  firstNameTh String?
  lastNameTh  String?

  dateOfBirth DateTime
  phoneNumber String?
  email       String?
  lineId      String?

  note String? @db.Text

  tags         CustomerTag[]
  interactions Interaction[]
  leads        Lead[]
  bookings     Booking[]

  addresses     Address[]
  passports     Passport[]
  foodAllergies FoodAllergy[]
  families      CustomerFamily[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Address {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  address     String
  province    String
  district    String
  subDistrict String
  postalCode  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Passport {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  passportNumber String
  issuingCountry String
  issuingDate    DateTime
  expiryDate     DateTime
  imageUrl       String?
  isPrimary      Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FoodAllergy {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  note  String?
  types FoodAllergyType[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tag {
  id        String        @id @default(uuid())
  name      String        @unique
  order     Int           @default(0)
  customers CustomerTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CustomerTag {
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  tagId      String
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([customerId, tagId])
}

// 3. Sales Pipeline & Leads
enum LeadSource {
  WEBSITE
  WALKIN
  REFERRAL
  SOCIAL
  LINE
  OTHER
}

enum LeadStatus {
  NEW
  CONTACTED
  QUOTED
  NEGOTIATING
  CLOSED_WON
  CLOSED_LOST
  ABANDONED
}

model Lead {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  agentId    String
  agent      User     @relation(fields: [agentId], references: [id])

  source              LeadSource @default(WEBSITE)
  status              LeadStatus @default(NEW)
  potentialValue      Decimal?   @db.Decimal(10, 2)
  destinationInterest String?
  travelDateEstimate  DateTime?
  notes               String?    @db.Text

  // Activity tracking
  lastActivityAt DateTime  @default(now())
  closedAt       DateTime?

  bookings    Booking[]
  commissions Commission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 4. Trip & Booking Management
enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  REFUNDED
}

enum VisaStatus {
  NOT_REQUIRED
  PENDING
  APPROVED
  REJECTED
}

model Trip {
  id          String   @id @default(uuid())
  name        String
  destination String
  startDate   DateTime
  endDate     DateTime
  maxCapacity Int
  description String?  @db.Text
  price       Decimal? @db.Decimal(10, 2)

  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Booking {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  leadId     String?
  lead       Lead?    @relation(fields: [leadId], references: [id])

  tripId String
  trip   Trip          @relation(fields: [tripId], references: [id])
  status BookingStatus @default(PENDING)

  totalAmount    Decimal    @db.Decimal(10, 2)
  paidAmount     Decimal    @default(0) @db.Decimal(10, 2)
  paymentDueDate DateTime?
  visaStatus     VisaStatus @default(NOT_REQUIRED)

  agentId String?
  agent   User?   @relation("AgentBookings", fields: [agentId], references: [id])

  payments    Payment[]
  commissions Commission[]

  tasks Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 5. Relationship & Tasks
enum InteractionType {
  CALL
  EMAIL
  LINE
  WHATSAPP
  MEETING
  OTHER
}

model Interaction {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  agentId    String
  agent      User     @relation(fields: [agentId], references: [id])

  type    InteractionType
  content String          @db.Text
  date    DateTime        @default(now())
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

model Task {
  id      String @id @default(uuid())
  agentId String
  agent   User   @relation(fields: [agentId], references: [id])

  relatedCustomerId String? // Optional loose link or strict? Let's keep it strict if possible, but maybe generic?
  // For simplicity in Prisma, let's not force a relation unless needed. 
  // But requirement said "Create follow-up tasks for each customer".
  // Let's link to Booking optionally too.

  relatedBookingId String?
  relatedBooking   Booking? @relation(fields: [relatedBookingId], references: [id])

  title       String
  description String?      @db.Text
  dueDate     DateTime
  isCompleted Boolean      @default(false)
  priority    TaskPriority @default(MEDIUM)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 6. Notifications
enum NotificationType {
  PASSPORT_EXPIRY
  TRIP_UPCOMING
  SYSTEM
}

model Notification {
  id     String @id @default(uuid())
  userId String // Agent who receives the alert
  user   User   @relation(fields: [userId], references: [id])

  type    NotificationType
  title   String
  message String
  link    String? // URL to redirect to (e.g., customer page)
  isRead  Boolean          @default(false)

  // Metadata to prevent duplicate alerts
  entityId String? // ID of the related entity (Passport ID, Trip ID)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 7. Finance & Commission
enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CREDIT_CARD
  OTHER
}

model Payment {
  id        String  @id @default(uuid())
  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  amount Decimal       @db.Decimal(10, 2)
  paidAt DateTime      @default(now())
  method PaymentMethod
  note   String?       @db.Text

  createdAt DateTime @default(now())
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
}

enum CommissionType {
  SALES // จากการหา Lead
  SERVICE // จากการดูแล Booking
  WALKIN // จาก Walk-in (ไม่มี Lead)
}

model Commission {
  id      String @id @default(uuid())
  agentId String
  agent   User   @relation(fields: [agentId], references: [id])

  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  leadId String?
  lead   Lead?   @relation(fields: [leadId], references: [id], onDelete: SetNull)

  type   CommissionType @default(SALES)
  rate   Decimal        @db.Decimal(5, 2)
  amount Decimal        @db.Decimal(10, 2)

  status CommissionStatus @default(PENDING)
  note   String?          @db.Text

  createdAt DateTime  @default(now())
  paidAt    DateTime?
}

// 8. Family Management
model Family {
  id String @id @default(uuid())

  name        String
  phoneNumber String?
  lineId      String?
  email       String?
  note        String? @db.Text

  customers CustomerFamily[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CustomerFamily {
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  familyId   String
  family     Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@id([customerId, familyId])
}
