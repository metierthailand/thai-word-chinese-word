// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// 1. Staff & Authentication
enum Role {
  SUPER_ADMIN
  ADMIN
  SALES
  STAFF
}

model User {
  id          String  @id @default(uuid())
  password    String?
  firstName   String
  lastName    String
  email       String  @unique
  phoneNumber String? @unique

  role              Role      @default(STAFF)
  commissionPerHead Decimal?  @db.Decimal(10, 2) // Amount, e.g., 1000.00
  isActive          Boolean   @default(true)
  resetToken        String?   @unique
  resetTokenExpiry  DateTime?

  leadsAsAgent  Lead[]         @relation("AgentLeads")
  leadsAsSales  Lead[]         @relation("SalesLeads")
  tasks         Task[]
  notifications Notification[]
  bookings      Booking[]      @relation("AgentBookings")
  salesBookings Booking[]      @relation("SalesBookings")
  commissions   Commission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 2. Customer Management
enum Title {
  MR
  MRS
  MISS
  MASTER
  OTHER
}

enum FoodAllergyType {
  DIARY
  EGGS
  FISH
  CRUSTACEAN
  GLUTEN
  PEANUT_AND_NUTS
  OTHER
}

model Customer {
  id String @id @default(uuid())

  title Title?

  firstNameEn String
  lastNameEn  String
  firstNameTh String?
  lastNameTh  String?

  dateOfBirth DateTime
  phoneNumber String?
  email       String?
  lineId      String?

  note String? @db.Text

  tags              CustomerTag[]
  leads             Lead[]
  bookings          Booking[]     @relation("CustomerBookings")
  companionBookings Booking[]     @relation("CompanionCustomers")

  addresses     Address[]
  passports     Passport[]
  foodAllergies FoodAllergy[]
  families      CustomerFamily[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tasks     Task[]
}

model Address {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  address     String
  province    String
  district    String
  subDistrict String
  postalCode  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Passport {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  passportNumber String
  issuingCountry String
  issuingDate    DateTime
  expiryDate     DateTime
  imageUrl       String?
  isPrimary      Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FoodAllergy {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  note  String?
  types FoodAllergyType[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tag {
  id        String        @id @default(uuid())
  name      String        @unique
  order     Int           @default(0)
  customers CustomerTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CustomerTag {
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  tagId      String
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([customerId, tagId])
}

// 3. Sales Pipeline & Leads
enum LeadSource {
  FACEBOOK
  YOUTUBE
  TIKTOK
  FRIEND
}

enum LeadStatus {
  INTERESTED
  BOOKED
  COMPLETED
  CANCELLED
}

model Lead {
  id          String    @id @default(uuid())
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)
  agentId     String
  agent       User      @relation("AgentLeads", fields: [agentId], references: [id])
  salesUserId String
  salesUser   User      @relation("SalesLeads", fields: [salesUserId], references: [id])

  source LeadSource @default(FACEBOOK)
  status LeadStatus @default(INTERESTED)

  tripInterest String

  newCustomer Boolean @default(false)
  firstName   String?
  lastName    String?

  phoneNumber String?
  email       String?
  lineId      String?

  pax Int @default(1)

  leadNote   String? @db.Text
  sourceNote String? @db.Text

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

// 4. Trip & Booking Management
enum RoomType {
  DOUBLE_BED
  TWIN_BED
}

enum SeatType {
  WINDOW
  MIDDLE
  AISLE
}

enum SeatClass {
  FIRST_CLASS
  BUSINESS_CLASS
  LONG_LEG
}

enum TripType {
  GROUP_TOUR
  PRIVATE_TOUR
}

enum PaymentStatus {
  DEPOSIT_PENDING
  DEPOSIT_PAID
  FULLY_PAID
  CANCELLED
}

enum PaymentRatio {
  FIRST_PAYMENT_100
  FIRST_PAYMENT_50
  FIRST_PAYMENT_30
}

model Trip {
  id String @id @default(uuid())

  type TripType @default(GROUP_TOUR)
  code String   @unique

  name String

  startDate DateTime
  endDate   DateTime

  pax Int @default(1)
  foc Int @default(1)

  tl String?
  tg String?

  staff String?

  standardPrice       Decimal @default(0) @db.Decimal(10, 2)
  extraPricePerPerson Decimal @default(0) @db.Decimal(10, 2)

  note String? @db.Text

  airlineAndAirportId String
  airlineAndAirport   AirlineAndAirport @relation(fields: [airlineAndAirportId], references: [id])

  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Booking {
  id                 String     @id @default(uuid())
  customerId         String
  customer           Customer   @relation("CustomerBookings", fields: [customerId], references: [id])
  salesUserId        String
  salesUser          User       @relation("SalesBookings", fields: [salesUserId], references: [id])
  tripId             String
  trip               Trip       @relation(fields: [tripId], references: [id])
  companionCustomers Customer[] @relation("CompanionCustomers")
  agentId            String?
  agent              User?      @relation("AgentBookings", fields: [agentId], references: [id])

  note String? @db.Text

  extraPriceForSingleTraveller Decimal? @db.Decimal(10, 2)
  roomType                     RoomType @default(DOUBLE_BED)

  extraPricePerBed Decimal @default(0) @db.Decimal(10, 2)
  roomNote         String? @db.Text

  seatType          SeatType   @default(WINDOW)
  seatClass         SeatClass?
  extraPricePerSeat Decimal?   @db.Decimal(10, 2)
  seatNote          String?    @db.Text

  extraPricePerBag Decimal? @db.Decimal(10, 2)
  bagNote          String?  @db.Text

  discountPrice Decimal? @db.Decimal(10, 2)
  discountNote  String?  @db.Text

  paymentStatus PaymentStatus @default(DEPOSIT_PENDING)

  firstPaymentRatio PaymentRatio @default(FIRST_PAYMENT_50)
  firstPaymentId    String?      @unique
  firstPayment      Payment?     @relation("FirstPayment", fields: [firstPaymentId], references: [id], onDelete: Cascade)
  secondPaymentId   String?      @unique
  secondPayment     Payment?     @relation("SecondPayment", fields: [secondPaymentId], references: [id], onDelete: Cascade)
  thirdPaymentId    String?      @unique
  thirdPayment      Payment?     @relation("ThirdPayment", fields: [thirdPaymentId], references: [id], onDelete: Cascade)

  payments    Payment[]    @relation("BookingPayments")
  commissions Commission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 5. Tasks
enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ContactType {
  CALL
  LINE
  MESSENGER
}

model Task {
  id String @id @default(uuid())

  status TaskStatus @default(TODO)

  topic       String
  description String? @db.Text

  // relate customer
  relatedCustomerId String?
  relatedCustomer   Customer? @relation(fields: [relatedCustomerId], references: [id])

  contact  ContactType?
  deadline DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
}

// 6. Notifications
enum NotificationType {
  PASSPORT_EXPIRY
  TRIP_UPCOMING
  SYSTEM
}

model Notification {
  id     String @id @default(uuid())
  userId String // Agent who receives the alert
  user   User   @relation(fields: [userId], references: [id])

  type    NotificationType
  title   String
  message String
  link    String? // URL to redirect to (e.g., customer page)
  isRead  Boolean          @default(false)

  // Metadata to prevent duplicate alerts
  entityId String? // ID of the related entity (Passport ID, Trip ID)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 7. Finance & Commission
model Payment {
  id        String  @id @default(uuid())
  bookingId String
  booking   Booking @relation("BookingPayments", fields: [bookingId], references: [id], onDelete: Cascade)

  amount         Decimal  @db.Decimal(10, 2)
  proofOfPayment String?
  paidAt         DateTime @default(now())

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  firstPayment  Booking? @relation("FirstPayment")
  secondPayment Booking? @relation("SecondPayment")
  thirdPayment  Booking? @relation("ThirdPayment")
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
}

model Commission {
  id      String @id @default(uuid())
  agentId String
  agent   User   @relation(fields: [agentId], references: [id])

  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  amount Decimal @db.Decimal(10, 2)

  status CommissionStatus @default(PENDING)
  note   String?          @db.Text

  createdAt DateTime  @default(now())
  paidAt    DateTime?
}

// 8. Family Management
model Family {
  id String @id @default(uuid())

  name        String
  phoneNumber String?
  lineId      String?
  email       String?
  note        String? @db.Text

  customers CustomerFamily[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CustomerFamily {
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  familyId   String
  family     Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@id([customerId, familyId])
}

// 9. Airline and Airport Management (IATA)
model AirlineAndAirport {
  id String @id @default(uuid())

  code String @unique
  name String

  trips Trip[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
